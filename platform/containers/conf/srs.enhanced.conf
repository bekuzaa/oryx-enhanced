# Enhanced SRS Configuration for Oryx with HLS Input and SRT Support
# This configuration extends the base SRS configuration with additional features

# Include the base configuration
include containers/conf/srs.release.conf

# Additional HLS input configuration
vhost __defaultVhost__ {
    # HLS input support
    hls_input {
        enabled on;
        # Allow HLS input streams
        hls_input_enabled on;
        # HLS input timeout
        hls_input_timeout 10;
        # HLS input buffer size
        hls_input_buffer_size 1024;
    }
    
    # Enhanced SRT configuration for 2 streams without Stream ID
    srt {
        enabled on;
        srt_to_rtmp on;
        # Maximum 2 SRT connections per port
        max_connections 2;
        # Allow connections without Stream ID
        allow_no_streamid on;
        # SRT connection timeout
        connect_timeout 4000;
        # Latency settings
        latency 20;
        peerlatency 20;
        recvlatency 20;
        # High quality mode
        tlpktdrop off;
        tsbpdmode off;
    }
    
    # HTTP hooks for monitoring
    http_hooks {
        enabled on;
        on_publish      http://localhost:2022/terraform/v1/hooks/srs/verify;
        on_unpublish    http://localhost:2022/terraform/v1/hooks/srs/verify;
        on_play         http://localhost:2022/terraform/v1/hooks/srs/verify;
        on_stop         http://localhost:2022/terraform/v1/hooks/srs/verify;
        on_hls          http://localhost:2022/terraform/v1/hooks/srs/hls;
        # Additional hooks for monitoring
        on_srt_connect  http://localhost:2022/terraform/v1/hooks/srs/srt_connect;
        on_srt_disconnect http://localhost:2022/terraform/v1/hooks/srs/srt_disconnect;
    }
    
    # HTTP API for monitoring
    http_api {
        enabled on;
        listen 127.0.0.1:1985;
        raw_api {
            enabled on;
            allow_reload on;
        }
        # Additional API endpoints for monitoring
        stats {
            enabled on;
            # Bandwidth monitoring
            bandwidth on;
            # Stream count monitoring
            stream_count on;
            # SRT connection monitoring
            srt_connections on;
        }
    }
    
    # HTTP server for HLS output
    http_server {
        enabled on;
        listen 8080;
        dir ./objs/nginx/html;
        # HLS output configuration
        hls {
            enabled on;
            mount [vhost]/[app]/[stream].m3u8;
            hls_path ./objs/nginx/html/hls;
            hls_fragment 2;
            hls_window 30;
            hls_cleanup on;
            hls_dispose 0;
            hls_nb not_in_sequence;
            hls_keys on;
            hls_key_file ./objs/nginx/html/keys/[app]/[stream].key;
            hls_key_url [vhost]/[app]/[stream].key;
        }
    }
    
    # RTMP configuration for output
    rtmp {
        enabled on;
        # Allow publishing from HLS input
        allow_publish all;
        # Allow playing all streams
        allow_play all;
        # RTMP chunk size
        chunk_size 4096;
        # RTMP buffer size
        buffer_size 4096;
    }
    
    # WebRTC configuration
    rtc {
        enabled on;
        nack on;
        twcc on;
        stun_timeout 30;
        dtls_role passive;
        # RTMP to WebRTC
        rtmp_to_rtc on;
        keep_bframe off;
        # WebRTC to RTMP
        rtc_to_rtmp on;
        pli_for_rtmp 6.0;
    }
}

# Additional vhost for HLS input processing
vhost hls_input {
    # HLS input specific configuration
    hls_input {
        enabled on;
        # HLS input timeout
        hls_input_timeout 10;
        # HLS input buffer size
        hls_input_buffer_size 1024;
        # Allow multiple HLS inputs
        hls_input_max_connections 10;
    }
    
    # HTTP hooks for HLS input
    http_hooks {
        enabled on;
        on_hls_input_start http://localhost:2022/terraform/v1/hooks/srs/hls_input_start;
        on_hls_input_stop http://localhost:2022/terraform/v1/hooks/srs/hls_input_stop;
        on_hls_input_error http://localhost:2022/terraform/v1/hooks/srs/hls_input_error;
    }
    
    # RTMP output for HLS input
    rtmp {
        enabled on;
        # Allow publishing from HLS input
        allow_publish all;
        # Allow playing all streams
        allow_play all;
    }
}

# Additional vhost for SRT input processing
vhost srt_input {
    # SRT specific configuration
    srt {
        enabled on;
        srt_to_rtmp on;
        # Maximum 2 SRT connections per port
        max_connections 2;
        # Allow connections without Stream ID
        allow_no_streamid on;
        # SRT connection timeout
        connect_timeout 4000;
        # Latency settings
        latency 20;
        peerlatency 20;
        recvlatency 20;
        # High quality mode
        tlpktdrop off;
        tsbpdmode off;
    }
    
    # HTTP hooks for SRT input
    http_hooks {
        enabled on;
        on_srt_connect http://localhost:2022/terraform/v1/hooks/srs/srt_connect;
        on_srt_disconnect http://localhost:2022/terraform/v1/hooks/srs/srt_disconnect;
        on_srt_publish http://localhost:2022/terraform/v1/hooks/srs/srt_publish;
        on_srt_unpublish http://localhost:2022/terraform/v1/hooks/srs/srt_unpublish;
    }
    
    # RTMP output for SRT input
    rtmp {
        enabled on;
        # Allow publishing from SRT input
        allow_publish all;
        # Allow playing all streams
        allow_play all;
    }
}

# Global configuration for monitoring
global {
    # Enable detailed logging for monitoring
    srs_log_tank console;
    srs_log_level trace;
    
    # Statistics configuration
    stats {
        enabled on;
        # Network statistics
        network on;
        # Stream statistics
        streams on;
        # SRT statistics
        srt on;
        # HLS statistics
        hls on;
    }
    
    # Performance tuning
    max_connections 2000;
    max_connections_per_ip 100;
    
    # Buffer configuration
    buffer_size 4096;
    chunk_size 4096;
    
    # Timeout configuration
    connect_timeout 4000;
    send_timeout 10000;
    recv_timeout 10000;
} 